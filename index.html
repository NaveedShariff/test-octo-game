<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spider Swinger</title>

  <!-- Open Graph / Twitter Card so tweets with your URL show a clickable preview -->
  <meta property="og:url" content="https://test-octo-game.vercel.app/">
  <meta property="og:title" content="Octo Swinger">
  <meta property="og:description" content="Swing, score, and share your badge!">
  <meta property="og:image" content="https://test-octo-game.vercel.app/share-default.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Octo Swinger">
  <meta name="twitter:description" content="Swing, score, and share your badge!">
  <meta name="twitter:image" content="https://test-octo-game.vercel.app/share-default.png">

  <style>
    :root{
      --sky1:#0b1f3a;
      --sky2:#0e355f;
      --sky3:#155a9c;
      --ground:#0b0f1a;
      --building:#101826;
      --building2:#0e1a2b;
      --accent:#ff2d55;
      --ui:#ffffff;
      --shadow:rgba(0,0,0,.3);
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--sky1),var(--sky2) 40%,var(--sky3) 90%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--ui);}    
    #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    canvas{width:100vw;height:100vh;display:block}
    .hud{position:fixed;left:0;top:0;right:0;display:flex;justify-content:space-between;align-items:flex-start;padding:12px 16px;pointer-events:none}
    .score{font-weight:700;font-size:20px;text-shadow:0 2px 6px var(--shadow)}
    .hint{opacity:.8;font-size:12px}
    .badge{background:rgba(255,255,255,.08);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.15);padding:8px 10px;border-radius:12px;box-shadow:0 8px 20px -8px var(--shadow)}

    /* Overlays */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:5}
    .overlay.show{display:flex}
    .panel{width:min(92vw,820px);background:rgba(16,24,38,.9);border:1px solid rgba(255,255,255,.18);border-radius:16px;box-shadow:0 24px 60px -24px rgba(0,0,0,.6);padding:20px}
    .panel h2{margin:6px 0 14px 0;font-size:24px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    .controls-bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .btn-ui{pointer-events:auto;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:var(--ui);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .btn-ui:active{transform:translateY(1px)}
    .input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.2);color:var(--ui)}
    .label{font-size:13px;opacity:.85;margin-bottom:6px;display:block}

    /* Top-right Menu button (lowered a bit) */
    #openMenuBtn{position:fixed;right:16px;top:80px;z-index:6}

    /* Mobile controls */
    .controls{position:fixed;inset:0;pointer-events:none}
    .pad{position:absolute;bottom:22px;display:flex;gap:14px;pointer-events:auto}
    .pad.left{
      left:22px;
      flex-direction:column;
      gap:16px;
    }
    .pad.right{right:22px}

    /* Default buttons (Left & Right) */
    .btn{
      width:90px;height:90px;border-radius:22px;display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:18px;text-transform:uppercase;color:var(--ui);
      background:rgba(255,255,255,.08);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.2);
      box-shadow:0 12px 30px -12px var(--shadow);user-select:none;-webkit-user-select:none;touch-action:manipulation;text-align:center
    }
    .btn:active{transform:translateY(1px)}

    /* Shoot Web button â€” taller/wider, red glass */
    .btn.accent{
      width:160px;height:196px;font-size:22px;line-height:1.2;white-space:nowrap;
      background:radial-gradient(circle at 30% 30%, rgba(255,45,85,.35), rgba(255,45,85,.15));
      border-color:rgba(255,45,85,.5);
    }

    /* Left = blue glass, Right = green glass */
    .btn.left-btn {
      background:radial-gradient(circle at 30% 30%, rgba(0,122,255,.35), rgba(0,122,255,.15));
      border-color:rgba(0,122,255,.5);
      color:#fff;
    }
    .btn.right-btn {
      background:radial-gradient(circle at 30% 30%, rgba(52,199,89,.35), rgba(52,199,89,.15));
      border-color:rgba(52,199,89,.5);
      color:#fff;
    }

    /* Square start menu layout */
    #startMenu .panel.start-square{
      width:min(92vw,300px);height:min(92vw,320px);
      display:grid;grid-template-rows:auto 1fr auto;gap:16px;padding:24px;
    }
    #startMenu .panel.start-square .title{margin:0;text-align:center;font-size:26px;font-weight:800}
    #startMenu .panel.start-square .score-cards{
      display:grid;grid-template-columns:1fr 1fr;align-items:center;justify-items:center;gap:10px
    }
    #startMenu .panel.start-square .score-card{display:flex;flex-direction:column;align-items:center;gap:8px}
    #startMenu .panel.start-square .label{font-size:14px;opacity:.9;margin:0}
    #startMenu .panel.start-square .score-big{font-size:44px;font-weight:900}
    #startMenu .panel.start-square .controls-square{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    #startMenu .panel.start-square .btn-ui{min-width:160px;height:44px;padding:0 16px;display:flex;align-items:center;justify-content:center}

    /* Square scorecard layout */
    #scorecard .panel.score-square{
      width:min(92vw,420px);height:min(92vw,420px);
      display:grid;grid-template-rows:auto 1fr auto auto;gap:16px;padding:24px;
    }
    #scorecard .panel.score-square .title{margin:0;text-align:center;font-size:24px;font-weight:800}
    #scorecard .panel.score-square .score-main{
      display:grid;grid-template-columns:1fr 1fr;align-items:center;justify-items:center;gap:16px
    }
    #scorecard .panel.score-square .left{display:flex;flex-direction:column;align-items:center;gap:10px;width:100%}
    #scorecard .panel.score-square .badge-img{width:120px;height:120px;object-fit:contain;image-rendering:auto}
    #scorecard .panel.score-square .badge-msg{text-align:center;opacity:.95;min-height:28px}
    #scorecard .panel.score-square .right{display:flex;flex-direction:column;align-items:center;gap:8px}
    #scorecard .panel.score-square .score-big{font-size:48px;font-weight:900}
    #scorecard .panel.score-square .input-row{display:flex;justify-content:center}
    #scorecard .panel.score-square .input{width:min(100%,300px)}
    #scorecard .panel.score-square .input::placeholder{color:rgba(255,255,255,.6)}
    .visually-hidden{position:absolute !important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
    #scorecard .panel.score-square .controls-square{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    #scorecard .panel.score-square .btn-ui{min-width:160px;height:44px;padding:0 16px;display:flex;align-items:center;justify-content:center}

    /* Hide the old hint; score remains */
    .hint{ display:none !important; }

    /* Device picker & tutorial panels */
    .panel.device-square, .panel.tutorial-square{
      width:min(92vw,420px);height:min(92vw,420px);
      display:grid;grid-template-rows:auto 1fr auto;gap:16px;padding:24px;border-radius:16px;
    }
    .panel .title{margin:0;text-align:center;font-size:24px;font-weight:800}
    .options{display:grid;gap:12px;align-content:center;justify-items:stretch}
    .btn-choice{
      padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.08);color:var(--ui);font-weight:800;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .tutorial-body{display:flex;flex-direction:column;gap:10px;font-size:14px;line-height:1.5;opacity:.95}
    .tutorial-body .kbd{
      display:inline-block;padding:2px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.08);font-weight:700;
    }
    .panel .controls-square{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div id="wrap"><canvas id="game" width="1280" height="720" aria-label="Spider Swinger Game Canvas"></canvas></div>

  <div class="hud">
    <div class="badge">
      <div class="score" id="score">Score: 0</div>
      <div class="hint">hidden</div>
    </div>
    <div class="badge" id="status">Swing: â€”</div>
  </div>

  <!-- Top-right Menu button -->
  <button id="openMenuBtn" class="btn btn-ui">Menu</button>

  <!-- Start Menu (hidden by default; shown after tutorial) -->
  <div id="startMenu" class="overlay" role="dialog" aria-modal="true">
    <div class="panel start-square">
      <h2 class="title">Octo Swinger</h2>
      <div class="score-cards">
        <div class="score-card">
          <div class="label">Best Score</div>
          <div id="bestScoreLabel" class="score-big">0</div>
        </div>
        <div class="score-card">
          <div class="label">Last Score</div>
          <div id="lastScoreLabel" class="score-big">0</div>
        </div>
      </div>
      <div class="controls-bar controls-square">
        <button id="startBtn" class="btn-ui">Start</button>
        <button id="openScorecardBtn" class="btn-ui">Download Score</button>
        <button id="shareXStartBtn" class="btn-ui">Share on X</button>
      </div>
    </div>
  </div>

  <!-- Device Picker -->
  <div id="devicePicker" class="overlay" role="dialog" aria-modal="true">
    <div class="panel device-square">
      <h2 class="title">Are you playing in what device?</h2>
      <div class="options">
        <button id="chooseMobileBtn" class="btn-choice">Mobile / Tablet</button>
        <button id="chooseDesktopBtn" class="btn-choice">Computer / Laptop</button>
      </div>
      <div class="controls-square">
        <div style="opacity:.7;font-size:12px;text-align:center">
          Weâ€™ll show a quick one-time tutorial for your device.
        </div>
      </div>
    </div>
  </div>

  <!-- Tutorial -->
  <div id="tutorial" class="overlay" role="dialog" aria-modal="true">
    <div class="panel tutorial-square">
      <h2 id="tutorialTitle" class="title">How to Play</h2>
      <div id="tutorialContent" class="tutorial-body"></div>
      <div class="controls-square">
        <button id="tutorialContinueBtn" class="btn-ui">Got it â€” Continue</button>
      </div>
    </div>
  </div>

  <!-- Scorecard -->
  <div id="scorecard" class="overlay" role="dialog" aria-modal="true">
    <div class="panel score-square">
      <h2 class="title">Score Card</h2>
      <div class="score-main">
        <div class="left">
          <img id="badgePreview" alt="badge" class="badge-img"/>
          <div id="badgeMessage" class="badge-msg"></div>
        </div>
        <div class="right">
          <div class="label">High Score</div>
          <div id="highScoreValue" class="score-big">0</div>
        </div>
      </div>
      <div class="input-row">
        <label class="visually-hidden" for="handleInput">Enter your X handle</label>
        <input id="handleInput" class="input" placeholder="Enter your X handle here!"/>
      </div>
      <div class="controls-bar controls-square">
        <button id="closeScorecardBtn" class="btn-ui">Close</button>
        <button id="downloadPngBtn" class="btn-ui">Download PNG</button>
        <button id="shareXBtn" class="btn-ui">Share on X</button>
      </div>
    </div>
  </div>

  <!-- Parallax clouds -->
  <div class="clouds" aria-hidden="true">
    <div class="cloud" style="left:5%; top:12%; width:260px; opacity:.35"></div>
    <div class="cloud" style="left:35%; top:22%; width:220px; opacity:.28"></div>
    <div class="cloud" style="left:65%; top:16%; width:280px; opacity:.25"></div>
    <div class="cloud" style="left:80%; top:30%; width:200px; opacity:.2"></div>
  </div>

  <!-- Mobile controls -->
  <div class="controls" aria-label="Mobile Controls">
    <div class="pad left">
      <div class="btn left-btn" data-hold="left" aria-label="Move Left">â—€ï¸Ž</div>
      <div class="btn right-btn" data-hold="right" aria-label="Move Right">â–¶ï¸Ž</div>
    </div>
    <div class="pad right">
      <div class="btn accent" data-hold="swing" aria-label="Shoot Web">Shoot Web</div>
    </div>
  </div>

  <script>
    /* ---------- small helpers ---------- */
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    const lerp=(a,b,t)=>a+(b-a)*t;
    const SITE_URL = 'https://test-octo-game.vercel.app/';
    const TUTORIAL_KEY = 'octo_tutorial_shown';

    // is user typing in an input/textarea/contenteditable?
    const isTyping = (e) => {
      const t = e.target;
      return t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable);
    };

    /* ---------- DOM refs ---------- */
    const canvas=document.getElementById('game');
    const ctx=canvas.getContext('2d');
    const statusEl=document.getElementById('status');
    const scoreEl=document.getElementById('score');

    const startMenu=document.getElementById('startMenu');
    const startBtn=document.getElementById('startBtn');
    const openMenuBtn=document.getElementById('openMenuBtn');
    const openScorecardBtn=document.getElementById('openScorecardBtn');
    const bestScoreLabel=document.getElementById('bestScoreLabel');
    const lastScoreLabel=document.getElementById('lastScoreLabel');

    const devicePicker = document.getElementById('devicePicker');
    const chooseMobileBtn = document.getElementById('chooseMobileBtn');
    const chooseDesktopBtn = document.getElementById('chooseDesktopBtn');
    const tutorial = document.getElementById('tutorial');
    const tutorialTitle = document.getElementById('tutorialTitle');
    const tutorialContent = document.getElementById('tutorialContent');
    const tutorialContinueBtn = document.getElementById('tutorialContinueBtn');

    const scorecard=document.getElementById('scorecard');
    const closeScorecardBtn=document.getElementById('closeScorecardBtn');
    const downloadPngBtn=document.getElementById('downloadPngBtn');
    const shareXBtn=document.getElementById('shareXBtn');
    const shareXStartBtn=document.getElementById('shareXStartBtn');
    const handleInput=document.getElementById('handleInput');
    const highScoreValue=document.getElementById('highScoreValue');
    const badgePreview=document.getElementById('badgePreview');
    const badgeMessage=document.getElementById('badgeMessage');

    /* ---------- sizing ---------- */
    let W=canvas.width, H=canvas.height;
    function resize(){
      const dpr=window.devicePixelRatio||1;
      canvas.width = Math.floor(window.innerWidth*dpr);
      canvas.height = Math.floor(window.innerHeight*dpr);
      W=canvas.width; H=canvas.height;
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', resize, {passive:true});
    resize();

    /* ---------- world state ---------- */
    const gravity=0.9, moveAccel=0.6, maxRunSpeed=8;
    const player={x:120,y:300,vx:0,vy:0,r:12,onGround:false,rope:null,ropeLen:0,dead:false};

    // preload player sprite
    const spideyImg = new Image(); spideyImg.src = 'player.png';
    let spideyReady=false; spideyImg.onload=()=>{ spideyReady=true; };

    const lavaHeight=120;
    const getLavaY = () => window.innerHeight - lavaHeight;
    let camX=0;

    // ðŸ”¹ time for lava animation
    let time = 0;

    const buildings=[]; // {x,w,h,top}
    const anchors=[];   // {x,y}

    function spawnInitialCity(){
      buildings.length=0; anchors.length=0;
      let x=0;
      for(let i=0;i<40;i++){
        const gap = (i===0)?0:Math.random()*90+60;
        x += gap + (i===0?0:buildings[i-1]?.w||0);
        const w=Math.random()*120+100;
        const h= lerp(window.innerHeight*0.25, window.innerHeight*0.6, Math.random());
        const top=getLavaY()-h; 
        buildings.push({x,w,h,top});
        const aCount = Math.random()<0.5?1:2;
        for(let k=0;k<aCount;k++){
          const ax = x + lerp(10,w-10, k/(aCount-1||1));
          const ay = top - 60 - Math.random()*40;
          anchors.push({x:ax,y:ay});
        }
      }
    }

    function extendCityIfNeeded(){
      const last=buildings[buildings.length-1];
      if(!last || player.x + 3000 > last.x + last.w){
        let x = last ? last.x + last.w : 0;
        for(let i=0;i<20;i++){
          const gap = Math.random()*110+70;
          x += gap;
          const w=Math.random()*140+110;
          const h= lerp(window.innerHeight*0.25, window.innerHeight*0.65, Math.random());
          const top=getLavaY()-h;
          buildings.push({x,w,h,top});
          const aCount = Math.random()<0.45?1:2;
          for(let k=0;k<aCount;k++){
            const ax = x + lerp(14,w-14, k/(aCount-1||1));
            const ay = top - 70 - Math.random()*60;
            anchors.push({x:ax,y:ay});
          }
          x += w;
        }
      }
    }

    spawnInitialCity();

    /* ---------- input ---------- */
    const keys={a:false,d:false,w:false,s:false};

    window.addEventListener('keydown',e=>{
      if (isTyping(e)) return; // don't hijack keys while typing in the handle input
      const k=e.key.toLowerCase();
      if(['w','a','d',' '].includes(k)) e.preventDefault();
      if(k==='a') keys.a=true;
      if(k==='d') keys.d=true;
      if(k==='w' || k===' ') keys.w=true;
      if(k==='r') restart();
    });

    window.addEventListener('keyup',e=>{
      if (isTyping(e)) return;
      const k=e.key.toLowerCase();
      if(k==='a') keys.a=false;
      if(k==='d') keys.d=false;
      if(k==='w' || k===' ') keys.w=false;
    });

    // stop game keys from bubbling when typing just in case
    handleInput.addEventListener('keydown', e => e.stopPropagation());
    handleInput.addEventListener('keyup', e => e.stopPropagation());

    // Mobile buttons (hold behavior)
    const holds={left:false,right:false,swing:false};
    for(const el of document.querySelectorAll('[data-hold]')){
      const name=el.getAttribute('data-hold');
      const set=(v)=>{holds[name]=v; if(name==='left') keys.a=v; if(name==='right') keys.d=v; if(name==='swing') keys.w=v;};
      const start=(e)=>{e.preventDefault(); set(true)};
      const end=(e)=>{e.preventDefault(); set(false)};
      el.addEventListener('touchstart',start,{passive:false});
      el.addEventListener('touchend',end,{passive:false});
      el.addEventListener('touchcancel',end,{passive:false});
      el.addEventListener('mousedown',start);
      el.addEventListener('mouseup',end);
      el.addEventListener('mouseleave',end);
    }

    /* ---------- swing attach/detach ---------- */
    function tryAttachWeb(){
      const range=420;
      let best=null, bestD=1e9;
      const facing = keys.a? -1 : (keys.d? 1 : 1);
      const px=player.x, py=player.y;
      for(const a of anchors){
        const dx=a.x-px, dy=a.y-py;
        const dist=Math.hypot(dx,dy);
        if(dist<range && dist<bestD && Math.sign(dx)===Math.sign(facing)){
          best=a; bestD=dist;
        }
      }
      if(best){
        player.rope={x:best.x,y:best.y};
        player.ropeLen=bestD;
      }
    }
    function detachWeb(){ player.rope=null; }

    /* ---------- collisions ---------- */
    function groundCollision(){
      player.onGround=false;
      for(const b of buildings){
        if(player.x> b.x && player.x < b.x+b.w){
          if(player.vy>=0 && player.y + player.r > b.top && player.y + player.r < b.top + 40){
            player.y=b.top - player.r; player.vy=0; player.onGround=true; return;
          }
        }
      }
    }

    /* ---------- scoring ---------- */
    let score=0; let bestX=0; let passed=0;
    let highestScore= Number(localStorage.getItem('spider_high_score')||0);
    let lastScore=0;
    let gameActive=false;
    let inMenu=true;
    let respawnTimer=0;

    function updateScore(){
      if(!gameActive) return;
      bestX=Math.max(bestX, player.x);
      score = Math.floor(bestX*0.1 + passed*25);
      scoreEl.textContent = `Score: ${score}`;
    }

    function placePlayerOnFirstBuilding(){
      const first = buildings[0];
      if(first){
        player.x = first.x + Math.min(40, first.w*0.25);
        player.y = first.top - player.r;
        player.vx = 0;
        player.vy = 0;
        player.onGround = true;
        camX = 0;
      }
    }

    function restart(){
      player.vx=2; player.vy=0; player.rope=null; player.onGround=false; player.dead=false; 
      bestX=0; score=0; passed=0; camX=0; gameActive=true; respawnTimer=0;
      spawnInitialCity();
      placePlayerOnFirstBuilding();
      updateScoreDisplay();
    }

    function respawn(){
      player.vx=2; player.vy=0; player.rope=null; player.onGround=false; player.dead=false;
      bestX=0; score=0; passed=0; camX=0; gameActive=true; respawnTimer=0;
      placePlayerOnFirstBuilding();
      updateScoreDisplay();
    }

    /* ---------- menus ---------- */
    function updateMenuLabels(){
      bestScoreLabel.textContent = highestScore;
      lastScoreLabel.textContent = lastScore;
    }
    function showMenu(){ gameActive=false; inMenu=true; startMenu.classList.add('show'); updateMenuLabels(); }
    function hideMenu(){ inMenu=false; startMenu.classList.remove('show'); }

    function endRun(){
      lastScore = score;
      highestScore = Math.max(highestScore, lastScore);
      localStorage.setItem('spider_high_score', String(highestScore));
      updateScoreDisplay();
      updateMenuLabels();
    }

    function computeBadgeForScore(s){
      if(s<=500)   return {name:'toddler', path:'action-icons/toddler.png', msg:'You are a Toddler'};
      if(s<=2000)  return {name:'ninja',   path:'action-icons/ninja.png',   msg:'You have good ninja stealth.'};
      if(s<=4000)  return {name:'samurai', path:'action-icons/samurai.png', msg:'You are a Samurai.'};
      if(s<=6000)  return {name:'spartan', path:'action-icons/spartan.png', msg:'You are a Spartan.'};
      if(s<=8000)  return {name:'messiah', path:'action-icons/messiah.png', msg:'You are Messiah'};
      return {name:'god', path:'action-icons/god.png', msg:'Congratulations, you are a God.'};
    }

    function openScorecard(){
      const badge=computeBadgeForScore(highestScore);
      badgePreview.src = badge.path;
      badgePreview.alt = badge.name;
      highScoreValue.textContent = highestScore;
      badgeMessage.textContent = badge.msg;
      scorecard.classList.add('show');
    }
    function closeScorecard(){ scorecard.classList.remove('show'); }

    /* ---------- Share on X (exact format you requested) ---------- */
    function shareOnX(score){
      // First line: message + URL on the same line
      const line1 = `I scored ${score} in Octo Swinger! ${SITE_URL}`;
      // Second line: note in braces, with a blank line before it
      const line2 = `{Kindly post this with Octo Score Card}`;
    
      // Put them together with a blank line between
      const text = encodeURIComponent(`${line1}\n\n${line2}`);
    
      // Open the X (Twitter) share intent with text only (URL already in text)
      const share = `https://twitter.com/intent/tweet?text=${text}`;
      window.open(share, '_blank');
    }

    /* ---------- Download scorecard PNG ---------- */
    function downloadScorecardPng(){
      const s = highestScore;
      const cardSrc =
        (s <= 500)  ? 'toddler-card.png' :
        (s <= 2000) ? 'ninja-card.png'   :
        (s <= 4000) ? 'samurai-card.png' :
        (s <= 6000) ? 'spartan-card.png' :
        (s <= 8000) ? 'messiah-card.png' :
                      'god-card.png';

      const handleRaw = (handleInput.value || '').trim();
      const handle = handleRaw ? (handleRaw.startsWith('@') ? handleRaw : '@' + handleRaw) : '@anonymous';

      function drawFittedText(g, text, rect, opts = {}){
        const {weight='900', preferredSize=64, minSize=18, family='Inter, Arial, sans-serif',
               align='center', vAlign='middle', padding=12, baseline='alphabetic', lineHeight=1.0} = opts;
        let fontSize = preferredSize;
        g.textAlign = align;
        g.textBaseline = baseline;
        g.fillStyle = '#222222';
        const maxWidth = rect.w - padding*2;
        const maxHeight = rect.h - padding*2;
        while (fontSize >= minSize){
          g.font = `${weight} ${fontSize}px ${family}`;
          const width = g.measureText(text).width;
          const height = fontSize * lineHeight;
          if (width <= maxWidth && height <= maxHeight) break;
          fontSize -= 1;
        }
        let x;
        if (align==='left') x = rect.x + padding;
        else if (align==='center') x = rect.x + rect.w/2;
        else x = rect.x + rect.w - padding;
        let y;
        if (vAlign==='top'){ g.textBaseline='top'; y = rect.y + padding; }
        else if (vAlign==='middle'){ g.textBaseline='middle'; y = rect.y + rect.h/2; }
        else { g.textBaseline='bottom'; y = rect.y + rect.h - padding; }
        g.fillText(text, x, y);
      }

      const base = new Image();
      base.onload = () => {
        const w = base.naturalWidth, h = base.naturalHeight;
        const c = document.createElement('canvas'); c.width=w; c.height=h;
        const g = c.getContext('2d');

        g.drawImage(base, 0, 0, w, h);

        // exact areas unchanged
        const HS_BOX     = { x:1176, y:70,  w:378,  h:212 };
        const HANDLE_BOX = { x: 644, y:461, w:1000, h:121 };

        drawFittedText(g, 'High Score', HS_BOX, {
          weight:'700', preferredSize:40, minSize:20, align:'center', vAlign:'top', padding:22
        });
        const SCORE_SUB = { x:HS_BOX.x, y:HS_BOX.y+78, w:HS_BOX.w, h:HS_BOX.h-78 };
        drawFittedText(g, String(highestScore), SCORE_SUB, {
          weight:'900', preferredSize:112, minSize:28, align:'center', vAlign:'middle', padding:20
        });
        drawFittedText(g, handle, HANDLE_BOX, {
          weight:'700', preferredSize:54, minSize:22, align:'left', vAlign:'middle', padding:28
        });

        // add visible site URL bottom-right (so reposted images still show your site)
        g.textAlign = 'right';
        g.textBaseline = 'alphabetic';
        g.fillStyle = '#222';
        g.font = '700 24px Inter, Arial, sans-serif';
        g.fillText('test-octo-game.vercel.app', w - 24, h - 24);

        const a=document.createElement('a');
        a.download='scorecard.png';
        a.href=c.toDataURL('image/png');
        a.click();
      };
      base.src = cardSrc;
    }

    /* ---------- UI buttons ---------- */
    startBtn.addEventListener('click',()=>{ hideMenu(); restart(); gameActive=true; });
    openMenuBtn.addEventListener('click',()=>{ showMenu(); });
    openScorecardBtn.addEventListener('click',()=>{ openScorecard(); });
    closeScorecardBtn.addEventListener('click',()=>{ closeScorecard(); });
    downloadPngBtn.addEventListener('click',()=>{ downloadScorecardPng(); });
    shareXBtn.addEventListener('click',()=> shareOnX(highestScore));
    shareXStartBtn.addEventListener('click',()=> shareOnX(highestScore));

    /* ---------- tutorial flow ---------- */
    function show(el){ el.classList.add('show'); inMenu = true; }
    function hide(el){ el.classList.remove('show'); }

    function showDevicePicker(){ show(devicePicker); }
    function showTutorial(kind){
      if(kind === 'mobile'){
        tutorialTitle.textContent = 'Mobile / Tablet â€” How to Play';
        tutorialContent.innerHTML = `
          <div>Use the on-screen controls:</div>
          <ul style="margin:0 0 6px 18px; padding:0">
            <li><span class="kbd">â—€ï¸Ž</span> Left button: move back</li>
            <li><span class="kbd">â–¶ï¸Ž</span> Right button: move forward</li>
            <li><span class="kbd">Shoot Web</span> button: attach / release your web to swing</li>
          </ul>
          <div>Tip: keep swinging and use left/right to build momentum!</div>
        `;
      } else {
        tutorialTitle.textContent = 'Computer / Laptop â€” How to Play';
        tutorialContent.innerHTML = `
          <div>Use your keyboard:</div>
          <ul style="margin:0 0 6px 18px; padding:0">
            <li><span class="kbd">A</span> move left</li>
            <li><span class="kbd">D</span> move right</li>
            <li><span class="kbd">W</span> (or Space) to shoot web (hold to stay attached)</li>
          </ul>
          <div>Tip: release at the right time to gain speed between anchors!</div>
        `;
      }
      hide(devicePicker); show(tutorial);
    }

    chooseMobileBtn.addEventListener('click', ()=> showTutorial('mobile'));
    chooseDesktopBtn.addEventListener('click', ()=> showTutorial('desktop'));
    tutorialContinueBtn.addEventListener('click', ()=>{
      localStorage.setItem(TUTORIAL_KEY, 'true');
      hide(tutorial);
      showMenu();
    });

    /* ---------- score display ---------- */
    function updateScoreDisplay(){
      if(gameActive){
        scoreEl.textContent = `Score: ${score}`;
      } else {
        scoreEl.textContent = `Latest: ${lastScore} | Best: ${highestScore}`;
      }
    }

    /* ---------- main loop ---------- */
    let lastTs=0;
    function step(ts){
      const dt = Math.min(33, ts-lastTs || 16);
      lastTs=ts;

      // advance time for lava animation
      time += dt / 1000;

      if(inMenu){
        render();
        requestAnimationFrame(step);
        return;
      }

      extendCityIfNeeded();

      if(player.onGround){
        if(keys.a) player.vx = clamp(player.vx - moveAccel, -maxRunSpeed, maxRunSpeed);
        if(keys.d) player.vx = clamp(player.vx + moveAccel, -maxRunSpeed, maxRunSpeed);
        if(!keys.a && !keys.d) player.vx *= 0.86;
      }

      if(keys.w && !player.rope) tryAttachWeb();
      if(!keys.w && player.rope) detachWeb();

      player.vy += gravity;
      player.x += player.vx; 
      player.y += player.vy;

      if(player.rope){
        const rx = player.rope.x - player.x;
        const ry = player.rope.y - player.y;
        const dist = Math.hypot(rx,ry) || 1;
        if(dist>player.ropeLen){
          const nx = rx/dist, ny = ry/dist;
          const px = player.rope.x - nx*player.ropeLen;
          const py = player.rope.y - ny*player.ropeLen;
          player.x = px; player.y = py;
          const vDot = player.vx*nx + player.vy*ny;
          player.vx -= vDot*nx;
          player.vy -= vDot*ny;
          const tangentX = -ny, tangentY = nx;
          if(keys.d) { player.vx += tangentX*0.25; player.vy += tangentY*0.25; }
          if(keys.a) { player.vx -= tangentX*0.25; player.vy -= tangentY*0.25; }
        }
      }

      groundCollision();

      // ðŸ”¸ CHANGE #2: Only die when falling off-screen (lava dips are safe)
      if(player.y - player.r > H + 300){ 
        if(gameActive) {
          player.dead=true; gameActive=false;
          highestScore = Math.max(highestScore, score);
          updateScoreDisplay();
          respawnTimer = 120;
          endRun();
        }
      }
      
      if(respawnTimer > 0) {
        respawnTimer--;
        if(respawnTimer === 0) respawn();
      }
      
      statusEl.textContent = player.dead ? 'Game Over â€” respawning in 2s...' : (player.rope ? 'Swing: attached' : 'Swing: free');

      camX = lerp(camX, player.x - window.innerWidth*0.35, 0.08);

      for(let i=passed;i<buildings.length;i++){
        if(buildings[i].x + buildings[i].w < player.x){ passed=i; }
        else break;
      }

      if(gameActive){ updateScore(); }
      render();
      requestAnimationFrame(step);
    }

    /* ---------- render ---------- */
    function render(){
      const vw = window.innerWidth; const vh = window.innerHeight;
      ctx.clearRect(0,0,vw,vh);

      const layers=[{offset:0.2,color:'rgba(10,16,28,0.6)'},{offset:0.35,color:'rgba(10,20,34,0.75)'}];
      layers.forEach((layer,idx)=>{
        ctx.fillStyle=layer.color;
        for(let i=0;i<buildings.length;i+=2){
          const b=buildings[i];
          const x = Math.floor(b.x*layer.offset - camX*layer.offset);
          const w=b.w*0.9;
          const h=b.h*0.9 + (idx*20);
          ctx.fillRect(x, vh - h*0.75, w, h*0.75);
        }
      });

      for(const b of buildings){
        const x = Math.floor(b.x - camX);
        const y = b.top;
        if(x+b.w < -200 || x > window.innerWidth+200) continue;
        const g=ctx.createLinearGradient(0,y,0,vh);
        g.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--building'));
        g.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--building2'));
        ctx.fillStyle=g;
        ctx.fillRect(x, y, b.w, b.h);
        ctx.fillStyle='rgba(255,255,255,0.06)';
        const cw=12,ch=18, gap=10;
        for(let cx=x+14; cx<x+b.w-10; cx+=cw+gap){
          for(let cy=y+14; cy<y+b.h-20; cy+=ch+gap){
            if(Math.random()>0.9) continue;
            ctx.fillRect(cx, cy, cw, ch);
          }
        }
      }

      ctx.fillStyle='rgba(255,255,255,0.6)';
      for(const a of anchors){
        const x = Math.floor(a.x - camX), y=a.y;
        if(x<-20||x>window.innerWidth+20) continue;
        ctx.beginPath(); ctx.arc(x,y,2,0,Math.PI*2); ctx.fill();
      }

      if(player.rope){
        ctx.strokeStyle='rgba(255,255,255,0.8)';
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(player.rope.x - camX, player.rope.y);
        ctx.lineTo(player.x - camX, player.y);
        ctx.stroke();
      }

      // ðŸ”¸ CHANGE #1: Realistic animated lava
      drawLava(ctx, vw, vh, time);

      if (spideyReady){
        const px = player.x - camX, py = player.y;
        const size = player.r * 3 + 4;
        ctx.drawImage(spideyImg, px - size/2, py - size/2, size, size);
      }

      const grd=ctx.createLinearGradient(0, vh-120, 0, vh);
      grd.addColorStop(0,'rgba(0,0,0,0)'); grd.addColorStop(1,'rgba(0,0,0,.3)');
      ctx.fillStyle=grd; ctx.fillRect(0, vh-120, vw, 120);
    }

    // ðŸ”¥ realistic lava renderer (wavy rim + glow + heat streaks + bubbles)
    function drawLava(g, vw, vh, t){
      const top=getLavaY();

      // body gradient
      const body=g.createLinearGradient(0, top, 0, vh);
      body.addColorStop(0,'#ff7930');
      body.addColorStop(0.35,'#ff3c13');
      body.addColorStop(1,'#7a0e0e');
      g.fillStyle=body; g.fillRect(0, top, vw, vh-top);

      // heat streaks
      g.globalAlpha=0.18;
      for(let i=0;i<5;i++){
        const y0=top + 10 + i*22 + Math.sin(t*0.8 + i)*6;
        g.beginPath();
        for(let x=0;x<=vw;x+=12){
          const off=Math.sin(x*0.01 + t*2 + i)*3 + Math.sin(x*0.035 - t*1.2 + i)*2;
          const y=y0 + off;
          if(x===0) g.moveTo(x,y); else g.lineTo(x,y);
        }
        g.lineWidth=6; g.strokeStyle='rgba(255,230,120,0.7)'; g.stroke();
      }
      g.globalAlpha=1;

      // wavy surface rim
      g.beginPath();
      for(let x=0;x<=vw;x+=8){
        const y = top
          + Math.sin(x*0.018 + t*2.2)*5
          + Math.sin(x*0.041 - t*1.4)*4
          + Math.sin(x*0.009 + t*3.1)*3;
        if(x===0) g.moveTo(0,y); else g.lineTo(x,y);
      }
      g.lineTo(vw,top+24); g.lineTo(0,top+24); g.closePath();
      const rim=g.createLinearGradient(0, top-8, 0, top+26);
      rim.addColorStop(0,'rgba(255,200,120,0)');
      rim.addColorStop(0.4,'rgba(255,200,120,0.8)');
      rim.addColorStop(1,'rgba(255,120,40,0.0)');
      g.fillStyle=rim; g.fill();

      // glow above surface
      const glow=g.createLinearGradient(0, top-50, 0, top+10);
      glow.addColorStop(0,'rgba(255,120,40,0)');
      glow.addColorStop(1,'rgba(255,120,40,0.28)');
      g.fillStyle=glow; g.fillRect(0, top-50, vw, 60);

      // bubbles
      const seed=Math.floor(t*2)%1000;
      for(let i=0;i<14;i++){
        const bx=((seed*9301 + i*49297)%233280)/233280;
        const x=bx*vw;
        const r=4 + ((i*7)%10);
        const y=vh - ((i*37 + (t*60)%vh)% (vh-top));
        g.beginPath(); g.arc(x, y, r, 0, Math.PI*2);
        g.fillStyle='rgba(255,220,140,0.25)'; g.fill();
        g.beginPath(); g.arc(x-r*0.3, y-r*0.3, r*0.4, 0, Math.PI*2);
        g.fillStyle='rgba(255,255,255,0.25)'; g.fill();
      }
    }

    /* ---------- boot ---------- */
    function updateScoreDisplay(){
      if(gameActive){ scoreEl.textContent = `Score: ${score}`; }
      else { scoreEl.textContent = `Latest: ${lastScore} | Best: ${highestScore}`; }
    }

    function show(el){ el.classList.add('show'); inMenu = true; }
    function hide(el){ el.classList.remove('show'); }

    function showDevicePicker(){ show(devicePicker); }

    // initial scene & flow
    spawnInitialCity();
    placePlayerOnFirstBuilding();

    if(localStorage.getItem(TUTORIAL_KEY) === 'true'){
      showMenu();
    } else {
      showDevicePicker();
    }

    // device picker events
    function showTutorial(kind){
      if(kind === 'mobile'){
        tutorialTitle.textContent = 'Mobile / Tablet â€” How to Play';
        tutorialContent.innerHTML = `
          <div>Use the on-screen controls:</div>
          <ul style="margin:0 0 6px 18px; padding:0">
            <li><span class="kbd">â—€ï¸Ž</span> Left button: move back</li>
            <li><span class="kbd">â–¶ï¸Ž</span> Right button: move forward</li>
            <li><span class="kbd">Shoot Web</span> button: attach / release your web to swing</li>
          </ul>
          <div>Tip: keep swinging and use left/right to build momentum!</div>
        `;
      } else {
        tutorialTitle.textContent = 'Computer / Laptop â€” How to Play';
        tutorialContent.innerHTML = `
          <div>Use your keyboard:</div>
          <ul style="margin:0 0 6px 18px; padding:0">
            <li><span class="kbd">A</span> move left</li>
            <li><span class="kbd">D</span> move right</li>
            <li><span class="kbd">W</span> (or Space) to shoot web (hold to stay attached)</li>
          </ul>
          <div>Tip: release at the right time to gain speed between anchors!</div>
        `;
      }
      hide(devicePicker); show(tutorial);
    }

    chooseMobileBtn.addEventListener('click', ()=> showTutorial('mobile'));
    chooseDesktopBtn.addEventListener('click', ()=> showTutorial('desktop'));
    tutorialContinueBtn.addEventListener('click', ()=>{ localStorage.setItem(TUTORIAL_KEY, 'true'); hide(tutorial); showMenu(); });

    requestAnimationFrame(step);
  </script>
</body>
</html>

